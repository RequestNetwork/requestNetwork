version: 2

references:
  working_directory: &working_directory
    ~/repo
  attach_workspace: &attach_workspace
  node_image: &node_image
    image: circleci/node:8
  ipfs_image: &ipfs_image
    image: ipfs/go-ipfs
  ganache_image: &ganache_image
    image: trufflesuite/ganache-cli
    command:
      - "-l"
      - "90000000"
      - "-m"
      - "candy maple cake sugar pudding cream honey rich smooth crumble sweet treat"

jobs:
  build:
    docker:
      - *node_image
    working_directory: *working_directory
    steps:
      - checkout
      - run:
          name: 'Install lerna'
          command: 'sudo npm install -g lerna'
      - run:
          name: 'Bootstrap'
          command: 'lerna bootstrap --concurrency=1'
      - persist_to_workspace:
          root: *working_directory
          paths: .
  test-library:
    docker:
      - *node_image
      - *ipfs_image
      - *ganache_image
    working_directory: *working_directory
    steps:
      - attach_workspace:
          at: *working_directory
      - run:
          name: 'Install lerna'
          command: 'sudo npm install -g lerna'
      - run:
          name: 'Deploy test contract'
          command: 'lerna run --scope @requestnetwork/request-network.js testdeploy'
      - run:
          name: 'Test requestNetwork.js library'
          command: 'lerna run --scope @requestnetwork/request-network.js test --stream'
  test-contract:
    docker:
      - *node_image
      - *ipfs_image
      - *ganache_image
    working_directory: *working_directory
    steps:
      - attach_workspace:
          at: *working_directory
      - run:
          name: 'Install lerna'
          command: 'sudo npm install -g lerna'
      - run:
          name: 'Deploy test contract'
          command: 'lerna run --scope @requestnetwork/request-network.js testdeploy'
      - run:
          name: 'Test requestNetwork contract'
          command: 'lerna run --scope request-network-smart-contracts test --stream'
  docs-library:
    docker:
      - *node_image
    working_directory: *working_directory
    steps:
      - attach_workspace:
          at: *working_directory
      - run:
          name: 'Install lerna'
          command: 'sudo npm install -g lerna @compodoc/compodoc'
      - run:
          name: 'Create library documentation'
          command: 'lerna run --scope @requestnetwork/request-network.js docs --stream'
  docs-contract:
    docker:
      - *node_image
    working_directory: *working_directory
    steps:
      - attach_workspace:
          at: *working_directory
      - run:
          name: 'Install lerna'
          command: 'sudo npm install -g lerna'
      - run:
          name: 'Create contract documentation'
          command: 'lerna run --scope request-network-smart-contracts docs:build --stream'

workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - test-library:
          requires:
            - build
      - test-contract:
          requires:
            - build
      - docs-library:
          requires:
            - build
            - test-library
      - docs-contract:
          requires:
            - build
            - test-contract
